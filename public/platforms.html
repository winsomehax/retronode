<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retronode - Platforms</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <style>
        body { background: #f5f5f5; color: #222; font-family: 'Roboto', Arial, sans-serif; margin: 0; padding: 0; min-height: 100vh; }
        .main-title { margin-top: 48px; font-weight: 500; letter-spacing: 1px; }
        .fab-btn { position: fixed; bottom: 36px; right: 36px; z-index: 1001; }
        .modal { max-width: 480px; }
        #backBtn { position: fixed; top: 24px; left: 24px; z-index: 1000; display: none; }
        .platform-thumb { width: 56px; height: 40px; object-fit: cover; border-radius: 6px; background: #eee; }
    </style>
</head>
<body>
    <ul id="navDrawer" class="sidenav">
        <li><a href="games.html" class="blue-text text-darken-2" id="navGames"><i class="material-icons left">sports_esports</i>Games</a></li>
        <li><a href="emulators.html" class="green-text text-darken-2" id="navEmulators"><i class="material-icons left">memory</i>Emulators</a></li>
    </ul>
    <div id="topNav" style="position:fixed;top:0;left:0;width:100vw;z-index:2000;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.04);padding:12px 0;display:flex;align-items:center;">
        <a href="#" data-target="navDrawer" class="sidenav-trigger" style="margin-left:16px;margin-right:16px;"><i class="material-icons">menu</i></a>
    </div>
    <div class="container" style="margin-top:100px;max-width:1100px;">
        <h4 class="main-title blue-text text-darken-2" style="margin-bottom:24px;">Platforms</h4>
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
            <div class="input-field" style="margin:0;flex:1;">
                <input id="searchInput" type="text" class="validate" placeholder="Search platforms...">
                <label for="searchInput" class="active" style="left:0;">Search</label>
            </div>
        </div>
        <table class="highlight responsive-table">
            <thead>
                <tr>
                    <th id="sortName" style="cursor:pointer;">Name <i class="material-icons" id="sortNameIcon" style="font-size:1rem;vertical-align:middle;">unfold_more</i></th>
                    <th>Description</th>
                    <th>Image</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="platformsTableBody"></tbody>
        </table>
    </div>
    <div id="crudDialog" class="modal">
        <div class="modal-content">
            <h5 id="crudDialogTitle"></h5>
            <form id="crudForm"></form>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn-flat">Cancel</a>
            <a href="#!" id="crudFormSubmit" class="btn blue">Save</a>
        </div>
    </div>
    <button id="backBtn" class="btn-floating btn-large waves-effect waves-light blue">
        <i class="material-icons">arrow_back</i>
    </button>
    <!-- Add FAB for adding new platforms -->
    <a id="addPlatformBtn" class="btn-floating btn-large waves-effect waves-light blue fab-btn" title="Add Platform">
        <i class="material-icons">add</i>
    </a>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        let platforms = {};
        let sortField = 'name';
        let sortAsc = true;
        let searchTerm = '';

        function renderPlatformsTable() {
            const tbody = document.getElementById('platformsTableBody');
            tbody.innerHTML = '';
            let filtered = Object.values(platforms).filter(platform => {
                return !searchTerm || (platform.name || '').toLowerCase().includes(searchTerm) || (platform.description || '').toLowerCase().includes(searchTerm);
            });
            filtered.sort((a, b) => {
                if (sortField === 'name') {
                    return sortAsc ? (a.name || '').localeCompare(b.name || '') : (b.name || '').localeCompare(a.name || '');
                }
                return 0;
            });
            filtered.forEach((platform, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${platform.name}</td>
                    <td>${platform.description || ''}</td>
                    <td><img src="${platform.image_url || ''}" alt="${platform.name}" class="platform-thumb" onerror="this.style.display='none'"></td>
                    <td style="white-space:nowrap;">
                        <button class="btn-flat blue-text edit-platform-btn" data-pid="${platform.name}" title="Edit"><i class="material-icons">edit</i></button>
                        <button class="btn-flat red-text delete-platform-btn" data-pid="${platform.name}" title="Delete"><i class="material-icons">delete</i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.edit-platform-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.preventDefault();
                    const pid = btn.getAttribute('data-pid');
                    openPlatformDialog('edit', Object.values(platforms).find(p => p.name === pid), pid);
                };
            });
            document.querySelectorAll('.delete-platform-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.preventDefault();
                    const pid = btn.getAttribute('data-pid');
                    if (confirm('Delete this platform?')) deletePlatform(pid);
                };
            });
            document.getElementById('sortNameIcon').textContent = sortField === 'name' ? (sortAsc ? 'arrow_upward' : 'arrow_downward') : 'unfold_more';
        }

        document.getElementById('searchInput').oninput = function() {
            searchTerm = this.value.trim().toLowerCase();
            renderPlatformsTable();
        };
        document.getElementById('sortName').onclick = function() {
            if (sortField === 'name') sortAsc = !sortAsc; else { sortField = 'name'; sortAsc = true; }
            renderPlatformsTable();
        };

        const addPlatformBtn = document.getElementById('addPlatformBtn');
        if (addPlatformBtn) {
            addPlatformBtn.onclick = function(e) {
                e.preventDefault();
                openPlatformDialog('add');
            };
        }

        function openPlatformDialog(mode, platform = {}, pid = null) {
            document.getElementById('crudDialogTitle').textContent = mode === 'edit' ? 'Edit Platform' : 'Add Platform';
            document.getElementById('crudForm').innerHTML = `
                <div class="input-field">
                    <input id="platformName" type="text" value="${platform.name || ''}" required>
                    <label for="platformName" class="active">Platform Name</label>
                </div>
                <div class="input-field">
                    <input id="platformDescription" type="text" value="${platform.description || ''}">
                    <label for="platformDescription" class="active">Description</label>
                </div>
                <div class="input-field">
                    <input id="platformImageUrl" type="url" value="${platform.image_url || ''}">
                    <label for="platformImageUrl" class="active">Image URL</label>
                </div>
            `;
            const modalElem = document.getElementById('crudDialog');
            let modalInstance = M.Modal.getInstance(modalElem);
            if (modalInstance) modalInstance.destroy();
            modalInstance = M.Modal.init(modalElem, {
                onOpenEnd: () => {
                    const saveBtn = document.getElementById('crudFormSubmit');
                    if (saveBtn) {
                        const newBtn = saveBtn.cloneNode(true);
                        saveBtn.parentNode.replaceChild(newBtn, saveBtn);
                        newBtn.onclick = function(e) {
                            e.preventDefault();
                            submitPlatformForm(mode, pid);
                        };
                    }
                }
            });
            modalInstance.open();
        }

        function submitPlatformForm(mode, pid) {
            const name = document.getElementById('platformName').value.trim();
            const description = document.getElementById('platformDescription').value.trim();
            const image_url = document.getElementById('platformImageUrl').value.trim();
            if (!name) { M.toast({html: 'Name is required'}); return; }
            const platformData = { name, description, image_url };
            if (mode === 'add') {
                fetch('/api/platforms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(platformData)
                }).then(r => r.json()).then(resp => {
                    if (resp.success) {
                        platforms[name.toLowerCase().replace(/[^a-z0-9]+/g, '')] = platformData;
                        renderPlatformsTable();
                        M.Modal.getInstance(document.getElementById('crudDialog')).close();
                        M.toast({html: 'Platform added!'});
                    } else {
                        M.toast({html: 'Failed to add platform'});
                    }
                });
            } else if (mode === 'edit') {
                fetch('/api/platforms/' + encodeURIComponent(pid), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(platformData)
                }).then(r => r.json()).then(resp => {
                    if (resp.success) {
                        platforms[pid.toLowerCase().replace(/[^a-z0-9]+/g, '')] = platformData;
                        renderPlatformsTable();
                        M.Modal.getInstance(document.getElementById('crudDialog')).close();
                        M.toast({html: 'Platform updated!'});
                    } else {
                        M.toast({html: 'Failed to update platform'});
                    }
                });
            }
        }

        function deletePlatform(pid) {
            fetch('/api/platforms/' + encodeURIComponent(pid), {
                method: 'DELETE'
            }).then(r => r.json()).then(resp => {
                if (resp.success) {
                    delete platforms[pid.toLowerCase().replace(/[^a-z0-9]+/g, '')];
                    renderPlatformsTable();
                    M.toast({html: 'Platform deleted!'});
                } else {
                    M.toast({html: 'Failed to delete platform'});
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            var modals = document.querySelectorAll('.modal');
            M.Modal.init(modals);
            var sidenavs = document.querySelectorAll('.sidenav');
            M.Sidenav.init(sidenavs, {edge: 'left'});
        });

        fetch('/api/platforms').then(r => r.json()).then(data => {
            platforms = data;
            renderPlatformsTable();
        });
    </script>
</body>
</html>
