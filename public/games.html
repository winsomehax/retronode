<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retronode - Games</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <style>
        body { background: #f5f5f5; color: #222; font-family: 'Roboto', Arial, sans-serif; margin: 0; padding: 0; min-height: 100vh; }
        .main-title { margin-top: 48px; font-weight: 500; letter-spacing: 1px; }
        .section-title { margin-top: 24px; font-weight: 400; }
        .fab-btn { position: fixed; bottom: 36px; right: 36px; z-index: 1001; }
        .hidden { display: none; }
        #backBtn { position: fixed; top: 24px; left: 24px; z-index: 1000; display: none; }
        .cover-thumb { 
            width: 48px; 
            height: 48px; 
            object-fit: cover; 
            border-radius: 6px; 
            background: #eee;
            transition: filter 0.3s ease-out;
        }
        .cover-thumb.loading {
            filter: blur(5px);
        }
        .cover-thumb.loaded {
            filter: none;
        }
        .modal { max-width: 480px; }
        /* Loading indicator styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .loading-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }
        /* Error message styles */
        .error-message {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: #f44336;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 2001;
            display: none;
        }
        .error-message.visible {
            display: block;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translate(-50%, 100%); }
            to { transform: translate(-50%, 0); }
        }
    </style>
    <!-- Import our modules -->
    <script type="module" src="/js/imageLoader.js"></script>
    <script type="module" src="/js/state.js"></script>
</head>
<body>
    <ul id="navDrawer" class="sidenav">
        <li><a href="platforms.html" class="blue-text text-darken-2" id="navPlatforms"><i class="material-icons left">dns</i>Platforms</a></li>
        <li><a href="emulators.html" class="green-text text-darken-2" id="navEmulators"><i class="material-icons left">memory</i>Emulators</a></li>
    </ul>
    <div id="topNav" style="position:fixed;top:0;left:0;width:100vw;z-index:2000;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.04);padding:12px 0;display:flex;align-items:center;">
        <a href="#" data-target="navDrawer" class="sidenav-trigger" style="margin-left:16px;margin-right:16px;"><i class="material-icons">menu</i></a>
    </div>
    <div class="container" style="margin-top:100px;max-width:1100px;">
        <h4 class="main-title blue-text text-darken-2" style="margin-bottom:24px;">Games</h4>
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
            <div class="input-field" style="margin:0;flex:1;">
                <input id="searchInput" type="text" class="validate" placeholder="Search games...">
                <label for="searchInput" class="active" style="left:0;">Search</label>
            </div>
            <div class="input-field" style="margin:0;width:220px;">
                <select id="platformFilter">
                    <option value="">All Platforms</option>
                </select>
                <label for="platformFilter" class="active">Filter by Platform</label>
            </div>
        </div>
        <table class="highlight responsive-table">
            <thead>
                <tr>
                    <th>Cover</th>
                    <th id="sortTitle" style="cursor:pointer;">Title <i class="material-icons" id="sortTitleIcon" style="font-size:1rem;vertical-align:middle;">unfold_more</i></th>
                    <th>Description</th>
                    <th id="sortPlatform" style="cursor:pointer;">Platforms <i class="material-icons" id="sortPlatformIcon" style="font-size:1rem;vertical-align:middle;">unfold_more</i></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="gamesTableBody"></tbody>
        </table>
    </div>
    <div id="crudDialog" class="modal">
        <div class="modal-content">
            <h5 id="crudDialogTitle"></h5>
            <form id="crudForm"></form>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn-flat">Cancel</a>
            <a href="#!" id="crudFormSubmit" class="btn blue">Save</a>
        </div>
    </div>
    <button id="backBtn" class="btn-floating btn-large waves-effect waves-light blue">
        <i class="material-icons">arrow_back</i>
    </button>
    <!-- Add FAB for adding new games -->
    <a id="addGameBtn" class="btn-floating btn-large waves-effect waves-light blue fab-btn" title="Add Game">
        <i class="material-icons">add</i>
    </a>
    <!-- IGDB Results Modal -->
    <div id="igdbResultsModal" class="modal">
        <div class="modal-content">
            <h5>Select Game Data from IGDB</h5>
            <div id="igdbResultsContainer"></div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn-flat">Cancel</a>
            <a href="#!" id="igdbImportBtn" class="btn blue disabled">Import Selected</a>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        const state = {
            games: [],
            platforms: {},
            currentPage: 1,
            itemsPerPage: 10,
            totalItems: 0,
            searchTerm: '',
            platformFilter: '',
            sortField: 'title',
            sortAsc: true,
            error: null,
            isLoading: false
        };

        // Safe string compare function that handles undefined/null values
        function safeCompare(a, b) {
            // Handle null, undefined, or empty values
            if (!a && !b) return 0;
            if (!a) return -1;
            if (!b) return 1;
            
            // Convert to strings, trimming whitespace
            const strA = String(a).trim();
            const strB = String(b).trim();
            
            // Case-insensitive comparison
            return strA.toLowerCase().localeCompare(strB.toLowerCase());
        }

        // Get platform names for a game
        function getPlatformNames(game) {
            if (!game?.platforms) return '';
            return Object.keys(game.platforms)
                .map(pid => {
                    const platform = state.platforms[pid];
                    return platform?.name || pid;
                })
                .filter(name => name && name.trim())
                .sort()
                .join(', ');
        }

        async function renderGamesTable() {
            const tableBody = document.getElementById('gamesTableBody');
            if (!tableBody) return;

            // Clear existing content
            tableBody.innerHTML = '';

            const state = retroNodeState.state;

            // Make sure we have games to display
            if (!Array.isArray(state.games)) {
                console.warn('No games available to display');
                return;
            }

            // Filter games
            let filtered = state.games.filter(game => {
                if (!game || typeof game !== 'object') return false;
                
                const title = (game.title || '').toLowerCase();
                const description = (game.description || '').toLowerCase();
                const searchStr = state.searchTerm.toLowerCase();
                
                const matchesSearch = !searchStr || 
                    title.includes(searchStr) || 
                    description.includes(searchStr);
                
                const matchesPlatform = !state.platformFilter || 
                    (game.platforms && state.platformFilter in game.platforms);
                
                return matchesSearch && matchesPlatform;
            });

            // Sort games
            filtered.sort((a, b) => {
                if (!a || !b) return 0;
                const sortMod = state.sortAsc ? 1 : -1;
                
                try {
                    switch (state.sortField) {
                        case 'title':
                            return sortMod * safeCompare(a.title, b.title);
                        case 'platforms':
                            return sortMod * safeCompare(getPlatformNames(a), getPlatformNames(b));
                        default:
                            return 0;
                    }
                } catch (err) {
                    console.error('Error during sort:', err);
                    return 0;
                }
            });

            // Calculate pagination
            state.totalItems = filtered.length;
            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            const endIndex = startIndex + state.itemsPerPage;
            const paginatedGames = filtered.slice(startIndex, endIndex);

            // Show loading state
            if (state.isLoading) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="center-align">
                            <div class="progress">
                                <div class="indeterminate"></div>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            // Show error state if any
            if (state.error) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="center-align">
                            <div class="red-text">${state.error}</div>
                        </td>
                    </tr>`;
                return;
            }

            // Render each game row
            paginatedGames.forEach((game, idx) => {
                if (!game) return;
                const platformNames = getPlatformNames(game);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="width:60px;">
                        <img src="${game.cover_image_path || '/img/default-cover.png'}" 
                             alt="${game.title || 'No title'}" 
                             class="cover-thumb"
                             onerror="this.src='/img/default-cover.png'">
                    </td>
                    <td>${game.title || 'No title'}</td>
                    <td>${game.description || 'No description'}</td>
                    <td>${platformNames || 'No platforms'}</td>
                    <td style="white-space:nowrap;">
                        <button class="btn-flat blue-text" onclick="openGameDialog('edit', retroNodeState.state.games[${startIndex + idx}], ${startIndex + idx})" title="Edit">
                            <i class="material-icons">edit</i>
                        </button>
                        <button class="btn-flat blue-text igdb-btn" data-title="${encodeURIComponent(game.title)}" data-row="${idx}" title="Find in IGDB">
                            <i class="material-icons">image_search</i>
                        </button>
                        <button class="btn-flat red-text" onclick="deleteGame(${startIndex + idx})" title="Delete">
                            <i class="material-icons">delete</i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Update pagination controls
            updatePagination();
        }

        function renderPlatformFilter() {
            const select = document.getElementById('platformFilter');
            select.innerHTML = '<option value="">All Platforms</option>' +
                Object.entries(state.platforms).map(([pid, p]) => `<option value="${pid}">${p.name}</option>`).join('');
            M.FormSelect.init(select);
            select.onchange = function() {
                state.platformFilter = select.value;
                renderGamesTable();
            };
        }

        function openGameDialog(mode, game = {}, idx = null) {
            document.getElementById('crudDialogTitle').textContent = mode === 'edit' ? 'Edit Game' : 'Add Game';
            // Platform selection: multi-select
            const platformOptions = Object.entries(platforms).map(([pid, p]) =>
                `<option value="${pid}" ${game.platforms && game.platforms[pid] ? 'selected' : ''}>${p.name}</option>`
            ).join('');
            document.getElementById('crudForm').innerHTML = `
                <div class="input-field">
                    <input id="gameTitle" type="text" value="${game.title || ''}" required>
                    <label for="gameTitle" class="active">Title</label>
                </div>
                <div class="input-field">
                    <input id="gameDescription" type="text" value="${game.description || ''}">
                    <label for="gameDescription" class="active">Description</label>
                </div>
                <div class="input-field">
                    <input id="gameCover" type="url" value="${game.cover_image_path || ''}">
                    <label for="gameCover" class="active">Cover Image URL</label>
                </div>
                <div class="input-field">
                    <select id="gamePlatforms" multiple>
                        ${platformOptions}
                    </select>
                    <label for="gamePlatforms" class="active">Platforms</label>
                </div>
                <div class="input-field" style="margin-top:16px;display:flex;gap:8px;">
                    <button id="askAiBtn" type="button" class="btn orange waves-effect waves-light" style="flex:1;"><i class="material-icons left">smart_toy</i>Ask AI</button>
                    <button id="igdbImportBtn" type="button" class="btn blue waves-effect waves-light" style="flex:1;"><i class="material-icons left">image_search</i>Import from IGDB</button>
                </div>
                <div id="igdbInlineResults" style="margin-top:8px;"></div>
            `;
            M.FormSelect.init(document.getElementById('gamePlatforms'));
            const modalElem = document.getElementById('crudDialog');
            // Always re-init modal with onOpenEnd to ensure handler is attached after render
            let modalInstance = M.Modal.getInstance(modalElem);
            if (modalInstance) modalInstance.destroy();
            modalInstance = M.Modal.init(modalElem, {
                onOpenEnd: () => {
                    const saveBtn = document.getElementById('crudFormSubmit');
                    if (saveBtn) {
                        // Remove any previous click handlers
                        const newBtn = saveBtn.cloneNode(true);
                        saveBtn.parentNode.replaceChild(newBtn, saveBtn);
                        newBtn.onclick = function(e) {
                            e.preventDefault();
                            submitGameForm(mode, idx);
                        };
                    }
                }
            });
            modalInstance.open();
            // Attach Ask AI button handler
            setTimeout(() => {
                const askAiBtn = document.getElementById('askAiBtn');
                if (askAiBtn) {
                    askAiBtn.onclick = async function() {
                        const title = document.getElementById('gameTitle').value.trim();
                        if (!title) { M.toast({html: 'Enter a game title first!'}); return; }
                        askAiBtn.disabled = true;
                        askAiBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Asking...';
                        try {
                            const resp = await fetch('/api/ai/game-info?title=' + encodeURIComponent(title));
                            const data = await resp.json();
                            if (data && data.description) {
                                document.getElementById('gameDescription').value = data.description;
                                M.updateTextFields();
                                M.toast({html: 'AI description filled!'});
                            } else {
                                M.toast({html: 'No info found from AI.'});
                            }
                        } catch (e) {
                            M.toast({html: 'AI request failed.'});
                        }
                        askAiBtn.disabled = false;
                        askAiBtn.innerHTML = '<i class="material-icons left">smart_toy</i>Ask AI';
                    };
                }
                // IGDB Import button handler
                const igdbBtn = document.getElementById('igdbImportBtn');
                if (igdbBtn) {
                    igdbBtn.onclick = async function() {
                        const title = document.getElementById('gameTitle').value.trim();
                        if (!title) { M.toast({html: 'Enter a game title first!'}); return; }
                        igdbBtn.disabled = true;
                        igdbBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Importing...';
                        const resultsDiv = document.getElementById('igdbInlineResults');
                        resultsDiv.innerHTML = '<div class="progress"><div class="indeterminate"></div></div>';
                        try {
                            const igdbResp = await fetch('/api/igdb/game', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ title })
                            });
                            const igdbData = await igdbResp.json();
                            resultsDiv.innerHTML = '';
                            if (igdbData && igdbData.results && igdbData.results.length) {
                                igdbData.results.forEach((game, idx) => {
                                    // Collect all possible cover images (cover + screenshots)
                                    let images = [];
                                    if (game.cover && game.cover.url) images.push({url: 'https:' + game.cover.url, type: 'cover'});
                                    (game.screenshots || []).forEach(s => images.push({url: 'https:' + s.url, type: 'screenshot'}));
                                    // Build image selection UI
                                    const imageOptions = images.map((img, i) =>
                                        `<label style='margin-right:8px;cursor:pointer;display:inline-block;position:relative;'>
                                            <input type='radio' name='igdbCover${idx}' value='${img.url}' ${i===0?'checked':''} style='position:absolute;left:-9999px;'>
                                            <img src='${img.url}' data-full='${img.url.replace("t_thumb","t_1080p")}' class='igdb-cover-thumb' style='width:48px;height:48px;object-fit:cover;border-radius:4px;border:2px solid ${i===0 ? '#1976d2' : '#bbb'};margin-bottom:2px;box-shadow:0 1px 4px #0002;transition:border-color 0.2s,box-shadow 0.2s;'>
                                            <span style='display:block;font-size:0.7em;text-align:center;color:#888;'>${img.type}</span>
                                            <span class='igdb-cover-selected' style='display:${i===0?'block':'none'};position:absolute;top:2px;right:2px;background:#1976d2;color:#fff;border-radius:50%;width:18px;height:18px;font-size:1em;line-height:18px;text-align:center;box-shadow:0 1px 4px #0003;'>✓</span>
                                        </label>`
                                    ).join('');
                                    const rating = game.rating ? `<span style='font-size:0.9em;color:#888;'>Rating: ${game.rating.toFixed(1)}</span>` : '';
                                    const summary = game.summary ? `<div style='font-size:0.95em;margin:8px 0;'>${game.summary.substring(0, 180)}${game.summary.length > 180 ? '...' : ''}</div>` : '';
                                    const video = (game.videos && game.videos[0]) ? `<a href='https://youtube.com/watch?v=${game.videos[0].video_id}' target='_blank'>🎬</a>` : '';
                                    resultsDiv.innerHTML += `
                                        <div class='card' style='display:flex;align-items:flex-start;gap:16px;margin-bottom:16px;padding:12px;box-shadow:0 2px 8px #0001;'>
                                            <div style='flex:1;'>
                                                <div style='display:flex;align-items:center;gap:16px;'>
                                                    <div style='display:flex;flex-direction:column;align-items:center;'>
                                                        <div class='igdb-image-options' data-idx='${idx}'>${imageOptions}</div>
                                                    </div>
                                                    <div>
                                                        <b>${game.name}</b> ${rating} ${video}
                                                        ${summary}
                                                    </div>
                                                </div>
                                                <div style='margin-top:8px;'>
                                                    <label><input type='checkbox' class='igdb-field' data-field='cover' checked> Cover</label>
                                                    <label><input type='checkbox' class='igdb-field' data-field='name' checked> Title</label>
                                                    <label><input type='checkbox' class='igdb-field' data-field='summary' checked> Summary</label>
                                                    <label><input type='checkbox' class='igdb-field' data-field='rating' ${game.rating ? 'checked' : 'disabled'}> Rating</label>
                                                </div>
                                            </div>
                                            <button class='btn blue igdb-import-btn' data-idx='${idx}' style='margin-left:16px;'>Import</button>
                                        </div>
                                    `;
                                });
                                // Attach import button handlers
                                resultsDiv.querySelectorAll('.igdb-import-btn').forEach(btn2 => {
                                    btn2.onclick = function() {
                                        const idx2 = parseInt(btn2.getAttribute('data-idx'));
                                        const game2 = igdbData.results[idx2];
                                        const card = btn2.closest('.card');
                                        const fields = Array.from(card.querySelectorAll('.igdb-field:checked')).map(cb=>cb.getAttribute('data-field'));
                                        // Get selected cover image
                                        let coverUrl = '';
                                        const selectedImg = card.querySelector(`.igdb-image-options input[type='radio']:checked`);
                                        if (selectedImg) coverUrl = selectedImg.value;
                                        if (fields.includes('cover') && coverUrl) document.getElementById('gameCover').value = coverUrl;
                                        if (fields.includes('name')) document.getElementById('gameTitle').value = game2.name;
                                        if (fields.includes('summary')) document.getElementById('gameDescription').value = game2.summary || '';
                                        if (fields.includes('rating') && game2.rating) document.getElementById('gameDescription').value += `\nRating: ${game2.rating.toFixed(1)}`;
                                        M.updateTextFields();
                                        resultsDiv.innerHTML = '';
                                    };
                                });
                                // Add mouseover for full-size preview
                                resultsDiv.querySelectorAll('.igdb-image-options img').forEach(img => {
                                    img.addEventListener('mouseenter', function(e) {
                                        let previewImg = document.getElementById('coverPreviewImg');
                                        if (!previewImg) {
                                            previewImg = document.createElement('img');
                                            previewImg.id = 'coverPreviewImg';
                                            previewImg.style.position = 'fixed';
                                            previewImg.style.zIndex = '3000';
                                            previewImg.style.display = 'none';
                                            previewImg.style.maxWidth = '320px';
                                            previewImg.style.maxHeight = '80vh';
                                            previewImg.style.boxShadow = '0 4px 24px rgba(0,0,0,0.25)';
                                            previewImg.style.borderRadius = '10px';
                                            previewImg.style.background = '#fff';
                                            previewImg.style.pointerEvents = 'none';
                                            document.body.appendChild(previewImg);
                                        }
                                        previewImg.src = this.getAttribute('data-full') || this.src;
                                        previewImg.style.display = 'block';
                                        // Position near mouse, but keep on screen
                                        const move = ev => {
                                            let x = ev.clientX + 24;
                                            let y = ev.clientY - 24;
                                            if (x + previewImg.width > window.innerWidth - 16) x = window.innerWidth - previewImg.width - 16;
                                            if (y + previewImg.height > window.innerHeight - 16) y = window.innerHeight - previewImg.height - 16;
                                            if (y < 0) y = 0;
                                            previewImg.style.left = x + 'px';
                                            previewImg.style.top = y + 'px';
                                        };
                                        move(e);
                                        window.addEventListener('mousemove', move);
                                        this._moveHandler = move;
                                    });
                                    img.addEventListener('mouseleave', function() {
                                        let previewImg = document.getElementById('coverPreviewImg');
                                        if (previewImg) previewImg.style.display = 'none';
                                        window.removeEventListener('mousemove', this._moveHandler);
                                    });
                                });
                                setTimeout(() => {
                                    resultsDiv.querySelectorAll('.igdb-image-options').forEach(optGroup => {
                                        const radios = optGroup.querySelectorAll('input[type="radio"]');
                                        radios.forEach(radio => {
                                            radio.addEventListener('change', function() {
                                                optGroup.querySelectorAll('img.igdb-cover-thumb').forEach(img => {
                                                    img.style.borderColor = '#bbb';
                                                    img.style.boxShadow = '0 1px 4px #0002';
                                                });
                                                optGroup.querySelectorAll('.igdb-cover-selected').forEach(sel => sel.style.display = 'none');
                                                const selectedLabel = this.closest('label');
                                                const img = selectedLabel.querySelector('img.igdb-cover-thumb');
                                                const sel = selectedLabel.querySelector('.igdb-cover-selected');
                                                if (img) {
                                                    img.style.borderColor = '#1976d2';
                                                    img.style.boxShadow = '0 0 0 2px #1976d2,0 1px 4px #0002';
                                                }
                                                if (sel) sel.style.display = 'block';
                                            });
                                        });
                                    });
                                }, 0);
                            } else {
                                resultsDiv.innerHTML = '<div class="card-panel yellow lighten-4">No IGDB results found.</div>';
                            }
                        } catch (e) {
                            resultsDiv.innerHTML = '<div class="card-panel red lighten-4">Error fetching IGDB data.</div>';
                        }
                        igdbBtn.disabled = false;
                        igdbBtn.innerHTML = '<i class="material-icons left">image_search</i>Import from IGDB';
                    };
                }
            }, 100);
        }

        function submitGameForm(mode, idx) {
            const title = document.getElementById('gameTitle').value.trim();
            const description = document.getElementById('gameDescription').value.trim();
            const cover = document.getElementById('gameCover').value.trim();
            const platformSelect = document.getElementById('gamePlatforms');
            const selectedPlatforms = Array.from(platformSelect.selectedOptions).map(opt => opt.value);
            if (!title) { M.toast({html: 'Title is required'}); return; }
            const gameData = {
                title,
                description,
                cover_image_path: cover,
                platforms: {}
            };
            selectedPlatforms.forEach(pid => { gameData.platforms[pid] = '' }); // ROM path left blank for now
            if (mode === 'add') {
                fetch('/api/games', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(gameData)
                }).then(r => r.json()).then(resp => {
                    if (resp.success) {
                        state.games.push(gameData);
                        renderGamesTable();
                        M.Modal.getInstance(document.getElementById('crudDialog')).close();
                        M.toast({html: 'Game added!'});
                    } else {
                        M.toast({html: 'Failed to add game'});
                    }
                });
            } else if (mode === 'edit') {
                fetch('/api/games/' + encodeURIComponent(state.games[idx].title), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(gameData)
                }).then(r => r.json()).then(resp => {
                    if (resp.success) {
                        state.games[idx] = gameData;
                        renderGamesTable();
                        M.Modal.getInstance(document.getElementById('crudDialog')).close();
                        M.toast({html: 'Game updated!'});
                    } else {
                        M.toast({html: 'Failed to update game'});
                    }
                });
            }
        }

        function deleteGame(idx) {
            fetch('/api/games/' + encodeURIComponent(state.games[idx].title), {
                method: 'DELETE'
            }).then(r => r.json()).then(resp => {
                if (resp.success) {
                    state.games.splice(idx, 1);
                    renderGamesTable();
                    M.toast({html: 'Game deleted!'});
                } else {
                    M.toast({html: 'Failed to delete game'});
                }
            });
        }

        async function showIgdbResults(results) {
            const modal = document.getElementById('igdbResultsModal');
            const container = document.getElementById('igdbResultsContainer');
            container.innerHTML = '';
            results.forEach((game, idx) => {
                const coverUrl = game.cover && game.cover.url ? 'https:' + game.cover.url : '';
                const rating = game.rating ? `<span style='font-size:0.9em;color:#888;'>Rating: ${game.rating.toFixed(1)}</span>` : '';
                const summary = game.summary ? `<div style='font-size:0.95em;margin:8px 0;'>${game.summary.substring(0, 180)}${game.summary.length > 180 ? '...' : ''}</div>` : '';
                const screenshots = (game.screenshots||[]).slice(0,3).map(s=>`<img src='https:${s.url}' style='width:48px;height:48px;object-fit:cover;margin-right:4px;border-radius:4px;'>`).join('');
                const video = (game.videos && game.videos[0]) ? `<a href='https://youtube.com/watch?v=${game.videos[0].video_id}' target='_blank'>🎬</a>` : '';
                container.innerHTML += `
                    <div class='card' style='display:flex;align-items:flex-start;gap:16px;margin-bottom:16px;padding:12px;box-shadow:0 2px 8px #0001;'>
                        <input type='radio' name='igdbSelect' value='${idx}' id='igdbRadio${idx}' style='margin-top:8px;'>
                        <label for='igdbRadio${idx}' style='flex:1;cursor:pointer;'>
                            <div style='display:flex;align-items:center;gap:16px;'>
                                <img src='${coverUrl}' style='width:64px;height:64px;object-fit:cover;border-radius:6px;background:#eee;'>
                                <div>
                                    <b>${game.name}</b> ${rating} ${video}
                                    ${summary}
                                    <div>${screenshots}</div>
                                </div>
                            </div>
                            <div style='margin-top:8px;'>
                                <label><input type='checkbox' class='igdb-field' data-field='cover' checked> Cover</label>
                                <label><input type='checkbox' class='igdb-field' data-field='name' checked> Title</label>
                                <label><input type='checkbox' class='igdb-field' data-field='summary' checked> Summary</label>
                                <label><input type='checkbox' class='igdb-field' data-field='rating' ${game.rating ? 'checked' : 'disabled'}> Rating</label>
                            </div>
                        </label>
                    </div>
                `;
            });
            M.Modal.getInstance(modal)?.destroy();
            M.Modal.init(modal);
            modal.querySelectorAll('input[name="igdbSelect"]').forEach(radio => {
                radio.onchange = () => {
                    document.getElementById('igdbImportBtn').classList.remove('disabled');
                };
            });
            document.getElementById('igdbImportBtn').onclick = function() {
                const selected = container.querySelector('input[name="igdbSelect"]:checked');
                if (!selected) return;
                const idx = parseInt(selected.value);
                const game = results[idx];
                const fields = Array.from(container.querySelectorAll('.igdb-field:checked')).map(cb=>cb.getAttribute('data-field'));
                // Example: fill the add/edit form with selected fields
                if (fields.includes('cover') && game.cover && game.cover.url) document.getElementById('gameCover').value = 'https:' + game.cover.url;
                if (fields.includes('name')) document.getElementById('gameTitle').value = game.name;
                if (fields.includes('summary')) document.getElementById('gameDescription').value = game.summary || '';
                if (fields.includes('rating') && game.rating) document.getElementById('gameDescription').value += `\nRating: ${game.rating.toFixed(1)}`;
                M.updateTextFields();
                M.Modal.getInstance(modal).close();
            };
            M.Modal.getInstance(modal).open();
        }

        async function showIgdbResultsInline(results, container, igdbRow) {
            container.innerHTML = '';
            if (!results.length) {
                container.innerHTML = '<div class="card-panel yellow lighten-4">No IGDB results found.</div>';
                return;
            }
            results.forEach((game, idx) => {
                // Collect all possible cover images (cover + screenshots)
                let images = [];
                if (game.cover && game.cover.url) images.push({url: 'https:' + game.cover.url, type: 'cover'});
                (game.screenshots || []).forEach(s => images.push({url: 'https:' + s.url, type: 'screenshot'}));
                // Build image selection UI
                const imageOptions = images.map((img, i) =>
                    `<label style='margin-right:8px;cursor:pointer;display:inline-block;position:relative;'>
                        <input type='radio' name='igdbCover${idx}' value='${img.url}' ${i===0?'checked':''} style='position:absolute;left:-9999px;'>
                        <img src='${img.url}' data-full='${img.url.replace("t_thumb","t_1080p")}' class='igdb-cover-thumb' style='width:48px;height:48px;object-fit:cover;border-radius:4px;border:2px solid ${i===0 ? '#1976d2' : '#bbb'};margin-bottom:2px;box-shadow:0 1px 4px #0002;transition:border-color 0.2s,box-shadow 0.2s;'>
                        <span style='display:block;font-size:0.7em;text-align:center;color:#888;'>${img.type}</span>
                        <span class='igdb-cover-selected' style='display:${i===0?'block':'none'};position:absolute;top:2px;right:2px;background:#1976d2;color:#fff;border-radius:50%;width:18px;height:18px;font-size:1em;line-height:18px;text-align:center;box-shadow:0 1px 4px #0003;'>✓</span>
                    </label>`
                ).join('');
                const rating = game.rating ? `<span style='font-size:0.9em;color:#888;'>Rating: ${game.rating.toFixed(1)}</span>` : '';
                const summary = game.summary ? `<div style='font-size:0.95em;margin:8px 0;'>${game.summary.substring(0, 180)}${game.summary.length > 180 ? '...' : ''}</div>` : '';
                const video = (game.videos && game.videos[0]) ? `<a href='https://youtube.com/watch?v=${game.videos[0].video_id}' target='_blank'>🎬</a>` : '';
                container.innerHTML += `
                    <div class='card' style='display:flex;align-items:flex-start;gap:16px;margin-bottom:16px;padding:12px;box-shadow:0 2px 8px #0001;'>
                        <input type='radio' name='igdbSelect' value='${idx}' id='igdbRadio${idx}' style='margin-top:8px;'>
                        <label for='igdbRadio${idx}' style='flex:1;cursor:pointer;'>
                            <div style='display:flex;align-items:center;gap:16px;'>
                                <div style='display:flex;flex-direction:column;align-items:center;'>
                                    <div class='igdb-image-options' data-idx='${idx}'>${imageOptions}</div>
                                </div>
                                <div>
                                    <b>${game.name}</b> ${rating} ${video}
                                    ${summary}
                                </div>
                            </div>
                            <div style='margin-top:8px;'>
                                <label><input type='checkbox' class='igdb-field' data-field='cover' checked> Cover</label>
                                <label><input type='checkbox' class='igdb-field' data-field='name' checked> Title</label>
                                <label><input type='checkbox' class='igdb-field' data-field='summary' checked> Summary</label>
                                <label><input type='checkbox' class='igdb-field' data-field='rating' ${game.rating ? 'checked' : 'disabled'}> Rating</label>
                            </div>
                        </label>
                        <button class='btn blue igdb-import-btn' data-idx='${idx}' style='margin-left:16px;'>Import</button>
                    </div>
                `;
            });
            // Attach import button handlers
            container.querySelectorAll('.igdb-import-btn').forEach(btn => {
                btn.onclick = function() {
                    const idx = parseInt(btn.getAttribute('data-idx'));
                    const game = results[idx];
                    const card = btn.closest('.card');
                    const fields = Array.from(card.querySelectorAll('.igdb-field:checked')).map(cb=>cb.getAttribute('data-field'));
                    // Get selected cover image
                    let coverUrl = '';
                    const selectedImg = card.querySelector(`.igdb-image-options input[type='radio']:checked`);
                    if (selectedImg) coverUrl = selectedImg.value;
                    // Helper to fill fields after modal is open
                    function fillFields() {
                        if (fields.includes('cover') && coverUrl) document.getElementById('gameCover').value = coverUrl;
                        if (fields.includes('name')) document.getElementById('gameTitle').value = game.name;
                        if (fields.includes('summary')) document.getElementById('gameDescription').value = game.summary || '';
                        if (fields.includes('rating') && game.rating) document.getElementById('gameDescription').value += `\nRating: ${game.rating.toFixed(1)}`;
                        M.updateTextFields();
                    }
                    // Check if form fields exist
                    if (!document.getElementById('gameTitle') || !document.getElementById('gameCover')) {
                        // Open add dialog, then fill fields after modal is rendered
                        openGameDialog('add');
                        setTimeout(fillFields, 200); // Wait for modal to render
                    } else {
                        fillFields();
                    }
                    if (openIgdbRow) { openIgdbRow.parentNode.removeChild(openIgdbRow); openIgdbRow = null; }
                };
            });
            // Add mouseover for full-size preview
            container.querySelectorAll('.igdb-image-options img').forEach(img => {
                img.addEventListener('mouseenter', function(e) {
                    let previewImg = document.getElementById('coverPreviewImg');
                    if (!previewImg) {
                        previewImg = document.createElement('img');
                        previewImg.id = 'coverPreviewImg';
                        previewImg.style.position = 'fixed';
                        previewImg.style.zIndex = '3000';
                        previewImg.style.display = 'none';
                        previewImg.style.maxWidth = '320px';
                        previewImg.style.maxHeight = '80vh';
                        previewImg.style.boxShadow = '0 4px 24px rgba(0,0,0,0.25)';
                        previewImg.style.borderRadius = '10px';
                        previewImg.style.background = '#fff';
                        previewImg.style.pointerEvents = 'none';
                        document.body.appendChild(previewImg);
                    }
                    previewImg.src = this.getAttribute('data-full') || this.src;
                    previewImg.style.display = 'block';
                    // Position near mouse, but keep on screen
                    const move = ev => {
                        let x = ev.clientX + 24;
                        let y = ev.clientY - 24;
                        if (x + previewImg.width > window.innerWidth - 16) x = window.innerWidth - previewImg.width - 16;
                        if (y + previewImg.height > window.innerHeight - 16) y = window.innerHeight - previewImg.height - 16;
                        if (y < 0) y = 0;
                        previewImg.style.left = x + 'px';
                        previewImg.style.top = y + 'px';
                    };
                    move(e);
                    window.addEventListener('mousemove', move);
                    this._moveHandler = move;
                });
                img.addEventListener('mouseleave', function() {
                    let previewImg = document.getElementById('coverPreviewImg');
                    if (previewImg) previewImg.style.display = 'none';
                    window.removeEventListener('mousemove', this._moveHandler);
                });
            });
        }

        // Materialize modal/select init
        document.addEventListener('DOMContentLoaded', function() {
            var modals = document.querySelectorAll('.modal');
            M.Modal.init(modals);
            var sidenavs = document.querySelectorAll('.sidenav');
            M.Sidenav.init(sidenavs, {edge: 'left'});
        });

        // Search handler
        document.getElementById('searchInput').oninput = function() {
            state.searchTerm = this.value.trim().toLowerCase();
            renderGamesTable();
        };

        // Sort handlers
        document.getElementById('sortTitle').onclick = function() {
            if (state.sortField === 'title') state.sortAsc = !state.sortAsc;
            else { state.sortField = 'title'; state.sortAsc = true; }
            renderGamesTable();
        };
        document.getElementById('sortPlatform').onclick = function() {
            if (state.sortField === 'platforms') state.sortAsc = !state.sortAsc;
            else { state.sortField = 'platforms'; state.sortAsc = true; }
            renderGamesTable();
        };

        // Ensure addGameBtn exists before attaching handler
        const addGameBtn = document.getElementById('addGameBtn');
        if (addGameBtn) {
            addGameBtn.onclick = function(e) {
                e.preventDefault();
                openGameDialog('add');
            };
        }

        // Initialize state management
const retroNodeState = new RetroNodeState();

// Subscribe to state changes
retroNodeState.subscribe((newState) => {
    renderGamesTable();
    renderPlatformFilter();
});

// Load initial data
Promise.all([
    fetch('/api/games').then(r => r.json()),
    fetch('/api/platforms').then(r => r.json())
]).then(([gamesResponse, platformsData]) => {
    if (gamesResponse.success && Array.isArray(gamesResponse.data)) {
        retroNodeState.setState({
            games: gamesResponse.data,
            totalItems: gamesResponse.pagination?.total || gamesResponse.data.length,
            platforms: platformsData
        });
    } else {
        console.error('Unexpected games data format:', gamesResponse);
        retroNodeState.setState({
            games: [],
            error: 'Failed to load games data'
        });
    }
});

        // Patch the IGDB button handler to show results inline under the relevant game row
        let openIgdbRow = null;
        document.addEventListener('click', async function(e) {
            if (e.target.closest('.igdb-btn')) {
                e.preventDefault();
                const btn = e.target.closest('.igdb-btn');
                const title = decodeURIComponent(btn.getAttribute('data-title'));
                const rowIdx = btn.getAttribute('data-row');
                // Remove any existing IGDB inline rows
                if (openIgdbRow) {
                    openIgdbRow.parentNode.removeChild(openIgdbRow);
                    openIgdbRow = null;
                }
                // Find the table row to insert after
                const tr = btn.closest('tr');
                // Insert a new row for IGDB results
                const igdbRow = document.createElement('tr');
                igdbRow.className = 'igdb-inline-row';
                igdbRow.innerHTML = `<td colspan="5"><div class="igdb-inline-section" style="margin-left:32px;"><div class="progress"><div class="indeterminate"></div></td>`;
                tr.parentNode.insertBefore(igdbRow, tr.nextSibling);
                openIgdbRow = igdbRow;
                // Fetch IGDB results
                const igdbResp = await fetch('/api/igdb/game', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });
                const igdbData = await igdbResp.json();
                const section = igdbRow.querySelector('.igdb-inline-section');
                section.innerHTML = '';
                if (igdbData && igdbData.results && igdbData.results.length) {
                    igdbData.results.forEach((game, idx) => {
                        // Collect all possible cover images (cover + screenshots)
                        let images = [];
                        if (game.cover && game.cover.url) images.push({url: 'https:' + game.cover.url, type: 'cover'});
                        (game.screenshots || []).forEach(s => images.push({url: 'https:' + s.url, type: 'screenshot'}));
                        // Build image selection UI
                        const imageOptions = images.map((img, i) =>
                            `<label style='margin-right:8px;cursor:pointer;display:inline-block;position:relative;'>
                                <input type='radio' name='igdbCover${idx}' value='${img.url}' ${i===0?'checked':''} style='position:absolute;left:-9999px;'>
                                <img src='${img.url}' data-full='${img.url.replace("t_thumb","t_1080p")}' class='igdb-cover-thumb' style='width:48px;height:48px;object-fit:cover;border-radius:4px;border:2px solid ${i===0 ? '#1976d2' : '#bbb'};margin-bottom:2px;box-shadow:0 1px 4px #0002;transition:border-color 0.2s,box-shadow 0.2s;'>
                                <span style='display:block;font-size:0.7em;text-align:center;color:#888;'>${img.type}</span>
                                <span class='igdb-cover-selected' style='display:${i===0?'block':'none'};position:absolute;top:2px;right:2px;background:#1976d2;color:#fff;border-radius:50%;width:18px;height:18px;font-size:1em;line-height:18px;text-align:center;box-shadow:0 1px 4px #0003;'>✓</span>
                            </label>`
                        ).join('');
                        const rating = game.rating ? `<span style='font-size:0.9em;color:#888;'>Rating: ${game.rating.toFixed(1)}</span>` : '';
                        const summary = game.summary ? `<div style='font-size:0.95em;margin:8px 0;'>${game.summary.substring(0, 180)}${game.summary.length > 180 ? '...' : ''}</div>` : '';
                        const video = (game.videos && game.videos[0]) ? `<a href='https://youtube.com/watch?v=${game.videos[0].video_id}' target='_blank'>🎬</a>` : '';
                        section.innerHTML += `
                            <div class='card' style='display:flex;align-items:flex-start;gap:16px;margin-bottom:16px;padding:12px;box-shadow:0 2px 8px #0001;'>
                                <div style='flex:1;'>
                                    <div style='display:flex;align-items:center;gap:16px;'>
                                        <div style='display:flex;flex-direction:column;align-items:center;'>
                                            <div class='igdb-image-options' data-idx='${idx}'>${imageOptions}</div>
                                        </div>
                                        <div>
                                            <b>${game.name}</b> ${rating} ${video}
                                            ${summary}
                                        </div>
                                    </div>
                                    <div style='margin-top:8px;'>
                                        <label><input type='checkbox' class='igdb-field' data-field='cover' checked> Cover</label>
                                        <label><input type='checkbox' class='igdb-field' data-field='name' checked> Title</label>
                                        <label><input type='checkbox' class='igdb-field' data-field='summary' checked> Summary</label>
                                        <label><input type='checkbox' class='igdb-field' data-field='rating' ${game.rating ? 'checked' : 'disabled'}> Rating</label>
                                    </div>
                                </div>
                                <button class='btn blue igdb-import-btn' data-idx='${idx}' style='margin-left:16px;'>Import</button>
                            </div>
                        `;
                    });
                    // Attach import button handlers
                    section.querySelectorAll('.igdb-import-btn').forEach(btn2 => {
                        btn2.onclick = function() {
                            const idx2 = parseInt(btn2.getAttribute('data-idx'));
                            const game2 = igdbData.results[idx2];
                            const card = btn2.closest('.card');
                            const fields = Array.from(card.querySelectorAll('.igdb-field:checked')).map(cb=>cb.getAttribute('data-field'));
                            // Get selected cover image
                            let coverUrl = '';
                            const selectedImg = card.querySelector(`.igdb-image-options input[type='radio']:checked`);
                            if (selectedImg) coverUrl = selectedImg.value;
                            // Helper to fill fields after modal is open
                            function fillFields() {
                                if (fields.includes('cover') && coverUrl) document.getElementById('gameCover').value = coverUrl;
                                if (fields.includes('name')) document.getElementById('gameTitle').value = game2.name;
                                if (fields.includes('summary')) document.getElementById('gameDescription').value = game2.summary || '';
                                if (fields.includes('rating') && game2.rating) document.getElementById('gameDescription').value += `\nRating: ${game2.rating.toFixed(1)}`;
                                M.updateTextFields();
                            }
                            // Check if form fields exist
                            if (!document.getElementById('gameTitle') || !document.getElementById('gameCover')) {
                                // Open add dialog, then fill fields after modal is rendered
                                openGameDialog('add');
                                setTimeout(fillFields, 200); // Wait for modal to render
                            } else {
                                fillFields();
                            }
                            if (openIgdbRow) { openIgdbRow.parentNode.removeChild(openIgdbRow); openIgdbRow = null; }
                        };
                    });
                    // Add mouseover for full-size preview
                    section.querySelectorAll('.igdb-image-options img').forEach(img => {
                        img.addEventListener('mouseenter', function(e) {
                            let previewImg = document.getElementById('coverPreviewImg');
                            if (!previewImg) {
                                previewImg = document.createElement('img');
                                previewImg.id = 'coverPreviewImg';
                                previewImg.style.position = 'fixed';
                                previewImg.style.zIndex = '3000';
                                previewImg.style.display = 'none';
                                previewImg.style.maxWidth = '320px';
                                previewImg.style.maxHeight = '80vh';
                                previewImg.style.boxShadow = '0 4px 24px rgba(0,0,0,0.25)';
                                previewImg.style.borderRadius = '10px';
                                previewImg.style.background = '#fff';
                                previewImg.style.pointerEvents = 'none';
                                document.body.appendChild(previewImg);
                            }
                            previewImg.src = this.getAttribute('data-full') || this.src;
                            previewImg.style.display = 'block';
                            // Position near mouse, but keep on screen
                            const move = ev => {
                                let x = ev.clientX + 24;
                                let y = ev.clientY - 24;
                                if (x + previewImg.width > window.innerWidth - 16) x = window.innerWidth - previewImg.width - 16;
                                if (y + previewImg.height > window.innerHeight - 16) y = window.innerHeight - previewImg.height - 16;
                                if (y < 0) y = 0;
                                previewImg.style.left = x + 'px';
                                previewImg.style.top = y + 'px';
                            };
                            move(e);
                            window.addEventListener('mousemove', move);
                            this._moveHandler = move;
                        });
                        img.addEventListener('mouseleave', function() {
                            let previewImg = document.getElementById('coverPreviewImg');
                            if (previewImg) previewImg.style.display = 'none';
                            window.removeEventListener('mousemove', this._moveHandler);
                        });
                    });
                    setTimeout(() => {
                        section.querySelectorAll('.igdb-image-options').forEach(optGroup => {
                            const radios = optGroup.querySelectorAll('input[type="radio"]');
                            radios.forEach(radio => {
                                radio.addEventListener('change', function() {
                                    optGroup.querySelectorAll('img.igdb-cover-thumb').forEach(img => {
                                        img.style.borderColor = '#bbb';
                                        img.style.boxShadow = '0 1px 4px #0002';
                                    });
                                    optGroup.querySelectorAll('.igdb-cover-selected').forEach(sel => sel.style.display = 'none');
                                    const selectedLabel = this.closest('label');
                                    const img = selectedLabel.querySelector('img.igdb-cover-thumb');
                                    const sel = selectedLabel.querySelector('.igdb-cover-selected');
                                    if (img) {
                                        img.style.borderColor = '#1976d2';
                                        img.style.boxShadow = '0 0 0 2px #1976d2,0 1px 4px #0002';
                                    }
                                    if (sel) sel.style.display = 'block';
                                });
                            });
                        });
                    }, 0);
                } else {
                    section.innerHTML = '<div class="card-panel yellow lighten-4">No IGDB results found.</div>';
                }
            }
        });

        function updatePagination() {
            // Calculate total pages
            const totalPages = Math.ceil(state.totalItems / state.itemsPerPage);
            
            // Add pagination controls
            const paginationContainer = document.createElement('div');
            paginationContainer.className = 'pagination center-align';
            paginationContainer.style.marginTop = '20px';
            
            // Previous button
            const prevBtn = document.createElement('a');
            prevBtn.className = `waves-effect waves-light btn-flat ${state.currentPage === 1 ? 'disabled' : ''}`;
            prevBtn.innerHTML = '<i class="material-icons">chevron_left</i>';
            prevBtn.onclick = () => {
                if (state.currentPage > 1) {
                    state.currentPage--;
                    renderGamesTable();
                }
            };
            
            // Next button
            const nextBtn = document.createElement('a');
            nextBtn.className = `waves-effect waves-light btn-flat ${state.currentPage === totalPages ? 'disabled' : ''}`;
            nextBtn.innerHTML = '<i class="material-icons">chevron_right</i>';
            nextBtn.onclick = () => {
                if (state.currentPage < totalPages) {
                    state.currentPage++;
                    renderGamesTable();
                }
            };
            
            // Page numbers
            const pageSpan = document.createElement('span');
            pageSpan.style.margin = '0 16px';
            pageSpan.textContent = `Page ${state.currentPage} of ${totalPages}`;
            
            paginationContainer.appendChild(prevBtn);
            paginationContainer.appendChild(pageSpan);
            paginationContainer.appendChild(nextBtn);
            
            // Replace any existing pagination
            const existingPagination = document.querySelector('.pagination');
            if (existingPagination) {
                existingPagination.replaceWith(paginationContainer);
            } else {
                document.getElementById('gamesTableBody').parentElement.after(paginationContainer);
            }
        }
    </script>
</body>
</html>
